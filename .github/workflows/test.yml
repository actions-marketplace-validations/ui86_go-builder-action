name: Test Action

on: [push, pull_request]

jobs:
  test-build:
    strategy:
      matrix:
        include:
          # 测试 1: Linux 基础编译
          - os: linux
            arch: amd64
            cgo: 'false'
            ext: 'tar.gz'
          # 测试 2: Windows 交叉编译 + CGO + Zip
          - os: windows
            arch: amd64
            cgo: 'true'
            ext: 'zip'

    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Go Cache
        uses: actions/cache@v3
        with:
          path: |
            .cache/go-build
            .cache/go-mod
          # 使用 go.sum 计算 hash，确保依赖变动时刷新缓存
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build Test App
        # 引用当前目录的 Action
        uses: ui86/go-builder-action@v1
        id: build
        with:
          project_path: './test'
          binary_name: 'test-app'
          release_tag: 'v0.0.1'
          goos: ${{ matrix.os }}
          goarch: ${{ matrix.arch }}
          cgo: ${{ matrix.cgo }}
          upx: true
          compress_assets: 'auto'
          cache: true
          md5: true

      - name: Verify Artifacts
        run: |
          echo "Verifying output..."
          
          FILE="test-app-v0.0.1-${{ matrix.os }}-${{ matrix.arch }}.${{ matrix.ext }}"
          
          if [ -f "$FILE" ]; then
            echo "✅ $FILE exists."
            ls -lh "$FILE"
          else
            echo "❌ $FILE not found! (Check naming logic in entrypoint.sh)"
            ls -R # 列出所有文件帮忙排错
            exit 1
          fi
          
          # 检查 Hash 文件
          if [ -f "$FILE.md5" ]; then
            echo "✅ Hash file exists."
          else
            echo "❌ Hash file missing!"
            exit 1
          fi